/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

window.formVisibilityGroups = function () {
  var defaultConfig = {
    template: "\n           <div>\n        <ul class=\"list-group\">\n            <!-- Loop through each group -->\n            <li class=\"list-group-item\" v-for=\"(group, groupIndex) in groups\" :key=\"groupIndex\">\n                <div class=\"d-flex justify-content-between mb-2\">\n                    <span>Group {{ groupIndex + 1 }}</span>\n                    <input type=\"hidden\" :name=\"prefix + 'Groups[' + groupIndex + '].IsRemoved'\" value=\"false\" />\n                    <button type=\"button\" class=\"btn btn-sm btn-danger\" @click=\"removeGroup(groupIndex)\">\n                        <i class=\"fa-solid fa-trash\"></i> Remove Group\n                    </button>\n                </div>\n\n                <!-- Loop through each rule -->\n                <ul class=\"list-group mb-3\">\n                    <!-- Loop through each rule in the group -->\n                    <li class=\"list-group-item\" v-for=\"(rule, ruleIndex) in group.rules\" :key=\"ruleIndex\">\n                        <div class=\"row\">\n                            <div class=\"col\">\n                                <select class=\"form-select\" v-model=\"rule.field\" :name=\"prefix + 'Groups[' + groupIndex + '].Rules[' + ruleIndex + '].Field'\">\n                                    <option value=\"\">Select Field</option>\n                                    <option v-for=\"option in fieldOptions\" :value=\"option.value\">\n                                        {{ option.text }}\n                                    </option>\n                                </select>\n                            </div>\n\n                            <div class=\"col\">\n                                <select class=\"form-select\" v-model=\"rule.operator\" :name=\"prefix + 'Groups[' + groupIndex + '].Rules[' + ruleIndex + '].Operator'\">\n                                    <option value=\"\">Select Operator</option>\n                                    <option v-for=\"option in operatorsList(rule.field)\" :value=\"option.value\">\n                                        {{ option.text }}\n                                    </option>\n                                </select>\n                            </div>\n\n                            <div class=\"col\">\n                                <input type=\"text\" class=\"form-control\" v-model=\"rule.value\" placeholder=\"Value\" :name=\"prefix + 'Groups[' + groupIndex + '].Rules[' + ruleIndex + '].Value'\" />\n                            </div>\n\n                            <div class=\"col-auto\">\n                                <input type=\"hidden\" :name=\"prefix + 'Groups[' + groupIndex + '].Rules[' + ruleIndex + '].IsRemoved'\" value=\"false\" />\n                                <button type=\"button\" class=\"btn btn-sm btn-danger\" @click=\"removeRule(groupIndex, ruleIndex)\">\n                                    <i class=\"fa-solid fa-trash\"></i> Remove Rule\n                                </button>\n                            </div>\n                        </div>\n                    </li>\n                    <li class=\"list-group-item\">\n                        <div class=\"d-flex justify-content-end mb-2\">\n                            <button type=\"button\" class=\"btn btn-sm btn-secondary\" @click=\"addRule(groupIndex)\">\n                                <i class=\"fa-solid fa-circle-plus\"></i> New Rule\n                            </button>\n                        </div>\n                    </li>\n                </ul>\n            </li>\n            <li class=\"list-group-item\">\n                <div class=\"d-flex justify-content-end\">\n                    <button type=\"button\" class=\"btn btn-sm btn-primary\" @click=\"addGroup()\">\n                        <i class=\"fa-solid fa-circle-plus\"></i> New Group\n                    </button>\n                </div>\n            </li>\n        </ul>\n    </div>\n        "
  };
  var initialize = function initialize(instanceConfig) {
    var config = Object.assign({}, defaultConfig, instanceConfig);
    if (!config.appElementSelector) {
      console.error('appElementSelector is required');
      return;
    }
    var groupCounter = 0;
    var app = new Vue({
      el: config.appElementSelector,
      data: function data() {
        return {
          groups: config.groupOptions || [],
          fieldOptions: config.fieldOptions || [],
          operatorOptions: config.operatorOptions || [],
          allOperatorOptions: config.operatorOptions || [],
          prefix: '',
          widgetId: config.widgetId
        };
      },
      computed: {
        groupsJson: function groupsJson() {
          return JSON.stringify(this.groups);
        }
      },
      methods: {
        addGroup: function addGroup() {
          var newGroup = {
            id: 'group-' + groupCounter++,
            rules: [{
              id: 'rule-' + Date.now() + '-' + Math.floor(Math.random() * 1000),
              field: '',
              operator: '',
              value: ''
            }]
          };
          this.groups.push(newGroup);
          this.$set(this.groups, this.groups.length - 1, newGroup);
        },
        addRule: function addRule(groupIndex) {
          var newRule = {
            id: 'rule-' + Date.now() + '-' + Math.floor(Math.random() * 1000),
            field: '',
            operator: '',
            value: ''
          };
          this.$set(this.groups[groupIndex].rules, this.groups[groupIndex].rules.length, newRule);
        },
        removeGroup: function removeGroup(groupIndex) {
          this.groups.splice(groupIndex, 1);
        },
        removeRule: function removeRule(groupIndex, ruleIndex) {
          this.groups[groupIndex].rules.splice(ruleIndex, 1);
        },
        populateFields: function populateFields() {
          var inputs = this.getInputs(document);
          this.fieldOptions = inputs.map(function (input) {
            return {
              value: input.htmlName,
              text: input.htmlName,
              type: input.htmlInputType
            };
          });
        },
        getInputs: function getInputs(el) {
          var widgetElements = el.querySelectorAll('.widget-template');
          var results = [];
          widgetElements.forEach(function (widget) {
            var formElementNameInput = widget.querySelector('input[name$="FormInputElementPart.Name"]');
            var inputTypeSelect = widget.querySelector('select[name$="InputPart.Type"]');
            if (formElementNameInput && inputTypeSelect) {
              var htmlName = formElementNameInput.value;
              var selectedOption = inputTypeSelect.options[inputTypeSelect.selectedIndex].value;
              if (!htmlName || !selectedOption) {
                return;
              }
              results.push({
                htmlName: htmlName,
                htmlInputType: selectedOption
              });
            }
          });
          return results;
        },
        operatorsList: function operatorsList(fieldId) {
          var field = this.fieldOptions.find(function (f) {
            return f.value === fieldId;
          });
          if (!field) return [];
          var mapping = this.operatorMapping();
          if (!mapping[field.type]) return [];
          return this.allOperatorOptions.filter(function (x) {
            return mapping[field.type].includes(x.value.toLowerCase());
          });
        },
        operatorMapping: function operatorMapping() {
          return {
            checkbox: ["is", "isnot"],
            text: ["is", "isnot", "empty", "notempty", "contains", "doesnotcontain", "startswith", "endswith"],
            number: ["is", "isnot", "greaterthan", "lessthan"],
            email: ["is", "isnot", "empty", "notempty"],
            tel: ["is", "isnot"],
            date: ["is", "isnot", "greaterthan", "lessthan"],
            time: ["is", "isnot", "greaterthan", "lessthan"],
            "datetime": ["is", "isnot", "greaterthan", "lessthan"],
            "datetime-local": ["is", "isnot", "greaterthan", "lessthan"],
            month: ["is", "isnot"],
            week: ["is", "isnot"],
            hidden: ["is", "isnot"],
            password: ["is", "isnot", "empty", "notempty"],
            color: ["is", "isnot"],
            range: ["is", "isnot", "greaterthan", "lessthan"],
            file: ["is", "isnot"],
            url: ["is", "isnot", "contains"],
            image: ["is", "isnot"],
            reset: ["is", "isnot"],
            search: ["is", "isnot", "contains"],
            submit: []
          };
        },
        toggleTabEvent: function toggleTabEvent() {
          var _this = this;
          document.addEventListener('shown.bs.tab', function (event) {
            if (!event.target.matches('[data-bs-toggle="tab"]')) {
              return;
            }
            var container = event.target.closest('.content-part-wrapper-form-part');
            var inputs = _this.getInputs(container || document);
            _this.fieldOptions = inputs.map(function (input) {
              return {
                value: input.htmlName,
                text: input.htmlName,
                type: input.htmlInputType
              };
            });
          });
        }
      },
      mounted: function mounted() {
        if (config.prefix) {
          this.prefix = config.prefix + '.';
        }
        this.toggleTabEvent();
        this.groups = config.groupOptions || [];
        this.operatorOptions = config.operatorOptions || [];
        this.allOperatorOptions = config.operatorOptions || [];
        this.populateFields();
        console.log(this.groups);
      },
      template: config.template
    });
    return app;
  };
  return {
    initialize: initialize
  };
}();